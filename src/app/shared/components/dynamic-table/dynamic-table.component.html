<div class="w-full space-y-4">
  <!-- Toolbar: Global Filter, Column Toggle, Export, Clear Filters -->
  @if (showToolbar()) {
  <div
    class="flex flex-col sm:flex-row gap-3 items-start sm:items-center justify-between p-4 bg-gray-50 dark:bg-gray-800/50 rounded-lg border border-gray-200 dark:border-gray-700">
    <div class="flex flex-col sm:flex-row gap-3 flex-1 w-full sm:w-auto">
      @if (config().globalFilter) {
      <span class="p-input-icon-left w-full sm:w-auto flex-1 sm:flex-initial">
        <i class="pi pi-search text-gray-400"></i>
        <input type="text" pInputText [value]="globalFilterValue()" (input)="onGlobalFilter($event)"
          placeholder="Search across all columns..." class="w-full pl-10" />
      </span>
      }
      @if (config().advancedFilter && hasActiveFilters()) {
      <p-button severity="secondary" [outlined]="true" (onClick)="clearFilters(dt)" class="w-full sm:w-auto">
        <i [class]="getFontAwesomeIcon('pi pi-filter-slash')" class="mr-2"></i>
        <span>Clear Filters</span>
      </p-button>
      }
      @if (config().columnToggle?.enabled) {
      <p-button severity="secondary" [outlined]="true" (onClick)="columnToggleMenu?.toggle($event)"
        class="w-full sm:w-auto">
        <i [class]="getFontAwesomeIcon('pi pi-list')" class="mr-2"></i>
        <span>Columns</span>
      </p-button>
      }
    </div>
    <div class="flex gap-2 w-full sm:w-auto">
      @if (config().exportable) {
      <p-button severity="secondary" [outlined]="true" (onClick)="exportCSV()" class="w-full sm:w-auto">
        <i [class]="getFontAwesomeIcon('pi pi-download')" class="mr-2"></i>
        <span>Export</span>
      </p-button>
      }
      @if (isSelectionEnabled() && selectedRows().length > 0) {
      <p-button severity="info" [outlined]="true" class="w-full sm:w-auto">
        <i [class]="getFontAwesomeIcon('pi pi-check-square')" class="mr-2"></i>
        <span>Selected: {{ selectedRows().length }}</span>
      </p-button>
      }
    </div>
  </div>
  }

  @if (config().columnToggle?.enabled) {
  <p-menu #columnToggleMenu [model]="[]" [popup]="true" />
  }

  <!-- Shared Action Menu -->
  <p-menu #sharedActionMenu [model]="activeRowMenuItems()" [popup]="true" appendTo="body" />

  <!-- Table Content Wrapper -->
  <div class="overflow-x-auto rounded-lg border border-gray-200 dark:border-gray-700 shadow-sm">
    <p-table #dt [value]="tableValue()" [lazy]="config().lazy || false" [totalRecords]="config().totalRecords || 0"
      [paginator]="paginationSettings().enabled" [rows]="paginationSettings().rows"
      [rowsPerPageOptions]="paginationSettings().options" [sortMode]="config().sortMode || 'single'"
      [selection]="isSelectionEnabled() ? selectedRows() : null"
      [selectionMode]="config().selection?.mode || 'multiple'" [dataKey]="'id'" [loading]="loading()"
      [scrollable]="scrollingSettings().scrollable" [scrollHeight]="scrollingSettings().height"
      [virtualScroll]="scrollingSettings().virtual" [stripedRows]="featureSettings().striped"
      [showGridlines]="featureSettings().gridlines" [resizableColumns]="featureSettings().resizable"
      [reorderableColumns]="featureSettings().reorderable" [editMode]="editSettings().mode" [rowHover]="true"
      [size]="config().size === 'large' ? 'large' : config().size === 'small' ? 'small' : undefined"
      [stateKey]="config().stateKey" [stateStorage]="config().stateStorage || 'session'"
      [expandedRowKeys]="expandedRows()" [filters]="filters()" [globalFilterFields]="filterableColumns()"
      (onSort)="onSort($event)" (onPage)="onPageChange($event)" (onRowSelect)="onSelectionChange($event)"
      (onRowUnselect)="onSelectionChange($event)" (onRowClick)="onRowClick($event)" (onFilter)="onFilter($event)"
      (onColumnResizeEnd)="onColumnResize($event)" (onColReorder)="onColumnReorder($event)"
      (onRowExpand)="onRowExpand($event)" (onRowCollapse)="onRowCollapse($event)" (onRowReorder)="onRowReorder($event)"
      styleClass="p-datatable-sm p-datatable-striped" [tableStyle]="{ 'min-width': '50rem' }">
      <!-- Table Header -->
      <ng-template pTemplate="header">
        <tr class="bg-gray-50 dark:bg-gray-800/50">
          @if (isExpansionEnabled()) {
          <th style="width: 3rem" class="p-3"></th>
          }
          @if (isSelectionEnabled() && isCheckboxSelection()) {
          <th style="width: 3rem" class="p-3 text-center">
            <p-tableHeaderCheckbox></p-tableHeaderCheckbox>
          </th>
          }
          @for (col of config().columns; track trackByField($index, col)) {
          <th [pSortableColumn]="col.sortable ? fieldToString(col.field) : undefined" [style.width]="col.width"
            [style.min-width]="col.minWidth" [style.max-width]="col.maxWidth"
            class="p-3 font-semibold text-gray-700 dark:text-gray-300 text-sm uppercase tracking-wider text-center"
            [class.text-left]="col.align === 'left'" [class.text-right]="col.align === 'right'">
            <div class="flex items-center gap-2">
              <span>{{ col.header }}</span>
              @if (col.sortable) {
              <p-sortIcon [field]="fieldToString(col.field)"></p-sortIcon>
              }
              @if (col.filterable && config().advancedFilter) {
              <span class="ml-auto">
                <p-columnFilter [type]="col.filterType || 'text'" [field]="fieldToString(col.field)" [display]="'menu'"
                  [showMenu]="true" [showOperator]="true" [showMatchModes]="true" [showAddButton]="true"
                  [matchModeOptions]="getFilterMatchModeOptions(col.filterType || 'text')" />
              </span>
              }
            </div>
          </th>
          }
          @if (hasActions()) {
          <th class="p-3 font-semibold text-gray-700 dark:text-gray-300 text-sm uppercase tracking-wider text-center">
            Actions</th>
          }
          @if (isRowEditingEnabled() && isRowEditingMode()) {
          <th class="p-3 font-semibold text-gray-700 dark:text-gray-300 text-sm uppercase tracking-wider text-center">
            Edit</th>
          }
        </tr>
      </ng-template>

      <!-- Table Body -->
      <ng-template pTemplate="body" let-rowData let-rowIndex="rowIndex" let-expanded="expanded">
        <tr [pSelectableRow]="isSelectionEnabled() ? rowData : null"
          class="hover:bg-gray-50 dark:hover:bg-gray-800/30 transition-colors border-b border-gray-100 dark:border-gray-700/50"
          [class.cursor-pointer]="!isRowEditingEnabled()" [class.bg-accent-light/20]="isRowEditing(rowData)"
          [class.dark:bg-accent-dark/20]="isRowEditing(rowData)">
          <!-- expansion toggle -->
          @if (isExpansionEnabled()) {
          <td class="p-3">
            @let rowExpanded = isRowExpanded(rowData);
            <button type="button" (click)="toggleRowExpansion(rowData); $event.stopPropagation()"
              class="p-button p-component p-button-text p-button-rounded p-button-sm p-button-icon-only w-8 h-8 flex items-center justify-center hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors cursor-pointer"
              [attr.aria-label]="rowExpanded ? 'Collapse row' : 'Expand row'" [attr.aria-expanded]="rowExpanded">
              <i [class]="getFontAwesomeIcon(rowExpanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right')"
                class="text-sm"></i>
            </button>
          </td>
          }

          <!-- selection checkbox -->
          @if (isSelectionEnabled() && isCheckboxSelection()) {
          <td class="p-3">
            <p-tableCheckbox [value]="rowData"></p-tableCheckbox>
          </td>
          }

          <!-- data columns -->
          @for (col of config().columns; track trackByField($index, col)) {
          <td
            [pEditableColumn]="isRowEditingEnabled() && isCellEditingMode() && col.editable ? fieldToString(col.field) : undefined"
            class="p-3 text-sm text-gray-900 dark:text-gray-100"
            [class.text-left]="col.align !== 'right' && col.align !== 'center'"
            [class.text-center]="col.align === 'center'" [class.text-right]="col.align === 'right'">
            <app-table-cell-editor [column]="col" [rowData]="rowData"
              [cellEditingMode]="isRowEditingEnabled() && isCellEditingMode() && col.editable || false"
              [rowEditingMode]="isRowEditingEnabled() && isRowEditingMode() && col.editable || false"
              [isRowEditing]="isRowEditing(rowData)" [editingValue]="getEditingValue(rowData, fieldToString(col.field))"
              (valueChange)="updateCellValue(rowData, $event.field, $event.value)" />
          </td>
          }

          <!-- action menu button -->
          @if (hasActions()) {
          <td class="p-3">
            <div class="flex justify-center items-center">
              <button type="button"
                (click)="showActionMenu($event, rowData, sharedActionMenu); $event.stopPropagation()"
                [disabled]="!hasVisibleActions(rowData)" [title]="'Actions'" class="w-10 h-10 min-w-[2.5rem] min-h-[2.5rem] rounded-lg flex items-center justify-center 
                         bg-gray-50 dark:bg-gray-800/50 
                         hover:bg-gradient-to-br hover:from-gray-100 hover:to-gray-200 
                         dark:hover:from-gray-700 dark:hover:to-gray-600
                         border border-gray-200 dark:border-gray-700
                         hover:border-gray-300 dark:hover:border-gray-600
                         hover:shadow-md transition-all duration-200
                         focus:outline-none focus:ring-2 focus:ring-gray-400 dark:focus:ring-gray-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800
                         disabled:opacity-40 disabled:cursor-not-allowed disabled:hover:bg-gray-50 disabled:hover:border-gray-200
                         group cursor-pointer" [attr.aria-label]="'Actions'">
                <i [class]="getFontAwesomeIcon(config().actionMenuIcon || 'pi pi-ellipsis-v')" class="text-base text-gray-600 dark:text-gray-400 
                            group-hover:text-gray-900 dark:group-hover:text-gray-100 
                            transition-colors duration-200"></i>
              </button>
            </div>
          </td>
          }

          <!-- row editing buttons -->
          @if (isRowEditingEnabled() && isRowEditingMode()) {
          <td class="p-3">
            <div class="flex gap-2 justify-center items-center">
              @if (isRowEditing(rowData)) {
              <button type="button" (click)="saveRowEdit(rowData); $event.stopPropagation()" [title]="'Save'"
                class="p-button p-component p-button-text p-button-rounded p-button-success p-button-sm p-button-icon-only w-10 h-10 min-w-[2.5rem] min-h-[2.5rem] flex items-center justify-center hover:bg-green-100 dark:hover:bg-green-900/30 transition-colors cursor-pointer"
                [attr.aria-label]="'Save'">
                <i [class]="getFontAwesomeIcon('pi pi-check')" class="text-base"></i>
              </button>
              <button type="button" (click)="cancelRowEdit(rowData); $event.stopPropagation()" [title]="'Cancel'"
                class="p-button p-component p-button-text p-button-rounded p-button-danger p-button-sm p-button-icon-only w-10 h-10 min-w-[2.5rem] min-h-[2.5rem] flex items-center justify-center hover:bg-red-100 dark:hover:bg-red-900/30 transition-colors cursor-pointer"
                [attr.aria-label]="'Cancel'">
                <i [class]="getFontAwesomeIcon('pi pi-times')" class="text-base"></i>
              </button>
              } @else {
              <button type="button" (click)="startRowEdit(rowData); $event.stopPropagation()" [title]="'Edit Row'"
                class="p-button p-component p-button-text p-button-rounded p-button-primary p-button-sm p-button-icon-only w-10 h-10 min-w-[2.5rem] min-h-[2.5rem] flex items-center justify-center hover:bg-accent-light/10 dark:hover:bg-accent-dark/10 transition-colors cursor-pointer"
                [attr.aria-label]="'Edit Row'">
                <i [class]="getFontAwesomeIcon('pi pi-pencil')" class="text-base"></i>
              </button>
              }
            </div>
          </td>
          }
        </tr>

        <!-- Expanded content Row -->
        @if (isExpansionEnabled() && isRowExpanded(rowData)) {
        <tr>
          <td [attr.colspan]="totalColspan()" class="p-4 bg-gray-50 dark:bg-gray-800/30">
            @if (getNestedConfigForRow(rowData)) {
            <div class="space-y-4">
              <div class="flex items-center gap-2 mb-4">
                <i class="pi pi-table text-gray-600 dark:text-gray-400"></i>
                <h4 class="text-lg font-semibold text-gray-900 dark:text-gray-100">Related Data</h4>
              </div>
              <app-dynamic-table [config]="getNestedConfigForRow(rowData)!" class="nested-table" />
            </div>
            } @else {
            <pre class="text-xs text-gray-600 dark:text-gray-400">{{ rowData | json }}</pre>
            }
          </td>
        </tr>
        }
      </ng-template>

      <!-- Empty State -->
      <ng-template pTemplate="emptymessage">
        <tr>
          <td [attr.colspan]="totalColspan()" class="p-0">
            <div class="text-center py-12">
              <i class="pi pi-inbox text-4xl text-gray-400 dark:text-gray-500 mb-4"></i>
              <p class="text-gray-500 dark:text-gray-400 text-lg font-medium">
                {{ config().emptyMessage || 'No data available' }}
              </p>
              @if (globalFilterValue() || hasActiveFilters()) {
              <p class="text-sm text-gray-400 dark:text-gray-500 mt-2">Try adjusting your search criteria</p>
              }
            </div>
          </td>
        </tr>
      </ng-template>

      <!-- Loading State -->
      <ng-template pTemplate="loadingbody">
        <tr>
          <td [attr.colspan]="totalColspan()" class="p-8 text-center">
            <i [class]="config().loadingIcon || 'pi pi-spin pi-spinner text-2xl text-gray-400'"></i>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </div>
</div>