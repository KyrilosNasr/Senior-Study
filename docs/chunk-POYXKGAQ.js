import{J as g,R as x,S as W,T as v,Z as A,a as _,b as y,ca as O,d as b,g as d,h as w,j as f}from"./chunk-IOSF2A54.js";var E={url:"",deserializer:i=>JSON.parse(i.data),serializer:i=>JSON.stringify(i)},$="WebSocketSubject.error must be called with an object with an error code, and an optional reason: { code: number, reason: string }",m=class i extends w{constructor(t,e){if(super(),this._socket=null,t instanceof b)this.destination=e,this.source=t;else{let s=this._config=Object.assign({},E);if(this._output=new d,typeof t=="string")s.url=t;else for(let c in t)t.hasOwnProperty(c)&&(s[c]=t[c]);if(!s.WebSocketCtor&&WebSocket)s.WebSocketCtor=WebSocket;else if(!s.WebSocketCtor)throw new Error("no WebSocket constructor can be found");this.destination=new f}}lift(t){let e=new i(this._config,this.destination);return e.operator=t,e.source=this,e}_resetState(){this._socket=null,this.source||(this.destination=new f),this._output=new d}multiplex(t,e,s){let c=this;return new b(n=>{try{c.next(t())}catch(a){n.error(a)}let o=c.subscribe({next:a=>{try{s(a)&&n.next(a)}catch(r){n.error(r)}},error:a=>n.error(a),complete:()=>n.complete()});return()=>{try{c.next(e())}catch(a){n.error(a)}o.unsubscribe()}})}_connectSocket(){let{WebSocketCtor:t,protocol:e,url:s,binaryType:c}=this._config,n=this._output,o=null;try{o=e?new t(s,e):new t(s),this._socket=o,c&&(this._socket.binaryType=c)}catch(r){n.error(r);return}let a=new _(()=>{this._socket=null,o&&o.readyState===1&&o.close()});o.onopen=r=>{let{_socket:p}=this;if(!p){o.close(),this._resetState();return}let{openObserver:S}=this._config;S&&S.next(r);let u=this.destination;this.destination=y.create(h=>{if(o.readyState===1)try{let{serializer:l}=this._config;o.send(l(h))}catch(l){this.destination.error(l)}},h=>{let{closingObserver:l}=this._config;l&&l.next(void 0),h&&h.code?o.close(h.code,h.reason):n.error(new TypeError($)),this._resetState()},()=>{let{closingObserver:h}=this._config;h&&h.next(void 0),o.close(),this._resetState()}),u&&u instanceof f&&a.add(u.subscribe(this.destination))},o.onerror=r=>{this._resetState(),n.error(r)},o.onclose=r=>{o===this._socket&&this._resetState();let{closeObserver:p}=this._config;p&&p.next(r),r.wasClean?n.complete():n.error(r)},o.onmessage=r=>{try{let{deserializer:p}=this._config;n.next(p(r))}catch(p){n.error(p)}}}_subscribe(t){let{source:e}=this;return e?e.subscribe(t):(this._socket||this._connectSocket(),this._output.subscribe(t),t.add(()=>{let{_socket:s}=this;this._output.observers.length===0&&(s&&(s.readyState===1||s.readyState===0)&&s.close(),this._resetState())}),t)}unsubscribe(){let{_socket:t}=this;t&&(t.readyState===1||t.readyState===0)&&t.close(),this._resetState(),super.unsubscribe()}};function k(i){return new m(i)}var j=class i{socket$;reconnectAttempts=0;maxReconnectAttempts=5;connect(t){return this.socket$=k({url:t,openObserver:{next:()=>{console.log("WebSocket connected"),this.reconnectAttempts=0}},closeObserver:{next:()=>{console.log("WebSocket disconnected"),this.reconnect()}}}),this.socket$.pipe(x(e=>e.pipe(W((s,c)=>{if(s>=this.maxReconnectAttempts)throw c;return s+1},0),g(1e3*Math.pow(2,this.reconnectAttempts)),A(()=>{this.reconnectAttempts++,console.log(`Reconnecting... (attempt ${this.reconnectAttempts})`)}))),v())}send(t){this.socket$&&!this.socket$.closed&&this.socket$.next(t)}close(){this.socket$&&this.socket$.complete()}reconnect(){this.reconnectAttempts<this.maxReconnectAttempts&&this.socket$&&setTimeout(()=>{this.reconnectAttempts++,console.log("Attempting to reconnect...")},1e3*Math.pow(2,this.reconnectAttempts))}simulateWebSocket(){return new b(t=>{let e=0,s=setInterval(()=>{e++,t.next({type:"message",payload:{id:e,text:`Message ${e}`,timestamp:Date.now()},timestamp:Date.now()})},2e3);return()=>clearInterval(s)})}static \u0275fac=function(e){return new(e||i)};static \u0275prov=O({token:i,factory:i.\u0275fac})};export{j as a};
